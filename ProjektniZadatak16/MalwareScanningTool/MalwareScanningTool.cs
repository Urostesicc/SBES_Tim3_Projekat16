using CertificateManager;
using Contracts;
using SecurityManager;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Security.Cryptography.X509Certificates;
using System.Security.Principal;
using System.ServiceModel;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Xml.Serialization;

namespace MalwareScanningTool
{
    class MalwareScanningTool : ChannelFactory<IIntrusionDetectionSystem>, IIntrusionDetectionSystem, IClientCommunication
    {
        private string whitelistPath = @"..\..\Whitelist.xml";

        public void Connect()
        {
            Console.WriteLine("Client connected.");
        }

        public void Disconnect()
        {
            Console.WriteLine("Client disconnected.");
        }

        public void CreateConfigurationFile()
        {
            CustomPrincipal principal = Thread.CurrentPrincipal as CustomPrincipal;
            string userName = Formatter.ParseName(principal.Identity.Name);

            if (Thread.CurrentPrincipal.IsInRole("Create"))
            {
                if (!File.Exists(whitelistPath))
                {
                    using (var stream = File.Create(whitelistPath))
                    {
                        Console.WriteLine("Whitelist created.");
                    }
                }
                else
                {
                    Console.WriteLine("Failed to create a Whitelist. Whitelist already exists.");
                }
            }
            else
            {
                Console.WriteLine("User unauthorized, need Create permission.");
            }
        }

        public void DeleteConfigurationFile()
        {

            CustomPrincipal principal = Thread.CurrentPrincipal as CustomPrincipal;
            string userName = Formatter.ParseName(principal.Identity.Name);

            if (Thread.CurrentPrincipal.IsInRole("Delete"))
            {
                if (File.Exists(whitelistPath))
                {
                    File.Delete(whitelistPath);
                    Console.WriteLine("Whitelist deleted.");
                }
                else
                {
                    Console.WriteLine("Cannot delete the Whitelist. It doesn't exist!");
                }
            }
            else
            {
                Console.WriteLine("User unauthorized, need Delete permission.");
            }
        }

        public void AddEntry(ConfigurationEntry entry)
        {

            CustomPrincipal principal = Thread.CurrentPrincipal as CustomPrincipal;
            string userName = Formatter.ParseName(principal.Identity.Name);

            if (Thread.CurrentPrincipal.IsInRole("Add"))
            {
                if (File.Exists(whitelistPath))
                {
                    XmlSerializer serializer = new XmlSerializer(typeof(List<ConfigurationEntry>));
                    List<ConfigurationEntry> entryList = new List<ConfigurationEntry>();

                    using (FileStream stream = File.OpenRead(whitelistPath))
                    {
                        try
                        {
                            entryList = (List<ConfigurationEntry>)serializer.Deserialize(stream);
                        }
                        catch (Exception e)
                        {
                            //Avoiding the empty database exception.
                        }
                    }
                    ConfigurationEntry lastEntry = entryList.Last();
                    entry.Id = lastEntry.Id + 1;
                    entryList.Add(entry);
                    using (var stream = File.Create(whitelistPath))
                    {
                        serializer.Serialize(stream, entryList);
                        Console.WriteLine("Entry added to Whitelist");
                    }
                }
                else
                {
                    Console.WriteLine("Cannot add Entry to the Whitelist. Whitelist doesn't exist.");
                }
            }
            else
            {
                Console.WriteLine("User unauthorized, need Add permission.");
            }
        }

        public void ModifyEntry(ConfigurationEntry entry)
        {
            CustomPrincipal principal = Thread.CurrentPrincipal as CustomPrincipal;
            string userName = Formatter.ParseName(principal.Identity.Name);

            if (Thread.CurrentPrincipal.IsInRole("Modify"))
            {
                if (File.Exists(whitelistPath))
                {
                    XmlSerializer serializer = new XmlSerializer(typeof(List<ConfigurationEntry>));
                    List<ConfigurationEntry> entryList = new List<ConfigurationEntry>();
                    ConfigurationEntry entryToRemove = null;

                    using (FileStream stream = File.OpenRead(whitelistPath))
                    {
                        try
                        {
                            entryList = (List<ConfigurationEntry>)serializer.Deserialize(stream);
                        }
                        catch (Exception e)
                        {
                            //Avoiding the empty database exception.
                        }
                    }
                    foreach (ConfigurationEntry existingEntry in entryList)
                    {
                        if (existingEntry.Id == entry.Id)
                        {
                            entryToRemove = existingEntry;
                            break;
                        }
                    }
                    if (entryToRemove != null)
                    {
                        entryList.Remove(entryToRemove);
                        try
                        {
                            entryList.Insert(entry.Id, entry);
                        }
                        catch
                        {
                            entryList.Add(entry);
                        }
                        using (var stream = File.Create(whitelistPath))
                        {
                            serializer.Serialize(stream, entryList);
                            Console.WriteLine("Entry modified.");
                        }
                    }
                    else
                    {
                        Console.WriteLine("Cannot modify Entry. Whitelist doesn't contain given Entry.");
                    }
                }
                else
                {
                    Console.WriteLine("Cannot add Entry to the Whitelist. Whitelist doesn't exist.");
                }
            }
            else
            {
                Console.WriteLine("User unauthorized, need Modify permission.");
            }
        }

        public void DeleteEntry(int id)
        {
            CustomPrincipal principal = Thread.CurrentPrincipal as CustomPrincipal;
            string userName = Formatter.ParseName(principal.Identity.Name);

            if (Thread.CurrentPrincipal.IsInRole("Delete"))
            {
                if (File.Exists(whitelistPath))
                {
                    XmlSerializer serializer = new XmlSerializer(typeof(List<ConfigurationEntry>));
                    List<ConfigurationEntry> entryList = new List<ConfigurationEntry>();
                    ConfigurationEntry entryToRemove = null;

                    using (FileStream stream = File.OpenRead(whitelistPath))
                    {
                        try
                        {
                            entryList = (List<ConfigurationEntry>)serializer.Deserialize(stream);
                        }
                        catch (Exception e)
                        {
                            //Avoiding the empty database exception.
                        }
                    }
                    foreach (ConfigurationEntry existingEntry in entryList)
                    {
                        if (existingEntry.Id == id)
                        {
                            entryToRemove = existingEntry;
                            break;
                        }
                    }
                    if (entryToRemove != null)
                    {
                        entryList.Remove(entryToRemove);
                        using (var stream = File.Create(whitelistPath))
                        {
                            serializer.Serialize(stream, entryList);
                            Console.WriteLine("Entry deleted.");

                        }
                    }
                    else
                    {
                        Console.WriteLine("Cannot delete Entry. Whitelist doesn't contain given Entry.");
                    }
                }
                else
                {
                    Console.WriteLine("Cannot delete Entry from the Whitelist. Whitelist doesn't exist.");
                }
            }
            else
            {
                Console.WriteLine("User unauthorized, need Delete permission.");
            }
        }

        public List<ConfigurationEntry> ReadConfigurationFile()
        {
            CustomPrincipal principal = Thread.CurrentPrincipal as CustomPrincipal;
            string userName = Formatter.ParseName(principal.Identity.Name);
            List<ConfigurationEntry> entryList = new List<ConfigurationEntry>();

            if (Thread.CurrentPrincipal.IsInRole("Read"))
            {
                if (File.Exists(whitelistPath))
                {
                    XmlSerializer serializer = new XmlSerializer(typeof(List<ConfigurationEntry>));

                    using (FileStream stream = File.OpenRead(whitelistPath))
                    {
                    }
                }
                else
                {
                    Console.WriteLine("Cannot read Entries from the Whitelist. Whitelist doesn't exist.");
                }
            }
            else
            {
                Console.WriteLine("User unauthorized, need Read permission.");
            }
            return entryList;
        }

        IIntrusionDetectionSystem factory;

        public MalwareScanningTool()
        {

        }

        public MalwareScanningTool(NetTcpBinding binding, EndpointAddress address) : base(binding, address)
        {
            //string name = "mst";
            string name = Formatter.ParseName(WindowsIdentity.GetCurrent().Name);
            name = name.ToLower();

            this.Credentials.ServiceCertificate.Authentication.CertificateValidationMode = System.ServiceModel.Security.X509CertificateValidationMode.ChainTrust;
            this.Credentials.ServiceCertificate.Authentication.RevocationMode = X509RevocationMode.NoCheck;

            this.Credentials.ClientCertificate.Certificate = CertManager.GetCertificateFromStorage(StoreName.My, StoreLocation.LocalMachine, name);

            factory = this.CreateChannel();
        }

        public void UpdateIDS(Alarm alarm)
        {
            try
            {
                factory.UpdateIDS(alarm);
            }
            catch (Exception e)
            {
                Console.WriteLine("[UpdateIDS] ERROR = {0}", e.Message);
            }
        }
    }
}